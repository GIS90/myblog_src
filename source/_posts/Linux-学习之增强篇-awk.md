---
title: Linuxå­¦ä¹ ä¹‹å¢å¼ºç¯‡-awk
desc: è®°å½•Linuxå‘½ä»¤å­¦ä¹ åŸºç¡€ç¯‡ä¹‹awk
categories:
  - [Linux]
tags: [Linux, Nginx, Linuxå¢å¼ºç¯‡]
comments: false
keywords: linux, awk, æœåŠ¡å™¨, å‘½ä»¤, æ—¥å¿—, grep, sed, nginxæ—¥å¿—, access-log, shell, bash
abbrlink: 35054
date: 2017-10-15 21:11:14
updated: 2017-11-21 21:11:14
---

### ç®€ä»‹

{% note danger %}
awkä¸æ­¢æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œå…¶å®æ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ã€‚
![](/images/article_awk.jpeg)
{% endnote %}

{% label default@Linux %} {% label primary@AWK %} {% label success@é«˜çº§æ•™ç¨‹ç³»åˆ— %} {% label info@æŸ¥çœ‹æ—¥å¿— %}

<!--more-->
<hr />

å¦‚æœä½ æ˜¯åšåç«¯ã€è¿ç»´ï¼Œæƒ³å¿…å¬è¯´è¿‡awkï¼Œgrepï¼Œsedç­‰æ—¥å¿—åˆ†æå‘½ä»¤ï¼Œä»Šå¤©ç»™å¤§å®¶å¸¦æ¥awkçš„è¯¦ç»†ç”¨æ³•ã€‚ç®€å•è¯´ä¸€ä¸‹åŸç†ï¼Œæ‰§è¡Œã€awk + æ–‡ä»¶ã€‘ä¼šæŠŠæ–‡ä»¶å†…å®¹æŒ‰è¡Œè¿›è¡Œè¯»å–ï¼Œè¡Œå†…å®¹ä»¥æŒ‡å®šçš„åˆ†éš”ç¬¦è¿›è¡Œåˆ‡å‰²ï¼ˆé»˜è®¤æ˜¯ç©ºæ ¼ï¼‰ï¼Œåˆ‡å¼€çš„éƒ¨åˆ†å†è¿›è¡Œå„ç§åˆ†æå¤„ç†ã€‚å·¥ä½œä¸Šæˆ‘ä¸»è¦ç”¨æ¥åšnginxçš„access-logæ—¥å¿—çš„åˆ†æï¼Œéå¸¸å¥½ç”¨ï¼Œç†Ÿç»ƒä½¿ç”¨ä¹‹åï¼Œåœ¨è§£ææ—¥å¿—ã€æ–‡æœ¬æ–¹é¢ä½ å°±ä¼šå¦‚é±¼å¾—æ°´ã€‚

### æ¨èæŒ‡æ•°
```
ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
```

### ä½¿ç”¨æ–¹æ³•
* ***awk -F 'åˆ†éš”ç¬¦' 'ç›¸å…³å‘½ä»¤' æ–‡ä»¶1,æ–‡ä»¶2,...***
* ***cat æ–‡ä»¶ | awk -F 'åˆ†éš”ç¬¦' 'ç›¸å…³å‘½ä»¤'***

> åˆ†éš”ç¬¦

awkä¼šä¾æ®-Fåçš„å‚æ•°â€˜â€™å¯¹æ•°æ®è¿›è¡Œåˆ‡å‰²ï¼Œå¸¸è§çš„åˆ†éš”ç¬¦***ç©ºæ ¼(â€˜ â€™)***ã€***å†’å·(â€˜:â€™)***ã€***å…³é”®å­—***ï¼Œéƒ½ä¸ºè‹±æ–‡å­—ç¬¦ã€‚

> å†…ç½®å˜é‡

|   å˜é‡   | è¯´æ˜                                    | æŒ‡æ•° |
|:--------:|:--------------------------------------- | :----: |
|    $0    | å½“å‰è®°å½•å†…å®¹ï¼ˆä½œä¸ºå•ä¸ªå˜é‡ï¼‰              |   ğŸŒŸ   |
|  $1~$n   | å½“å‰è®°å½•çš„ç¬¬nä¸ªå­—æ®µï¼Œå­—æ®µé—´ç”±-Få‚æ•°åˆ†éš” |   ğŸŒŸğŸŒŸğŸŒŸ   |
|    NF    | å½“å‰è®°å½•ä¸­çš„å­—æ®µä¸ªæ•°ï¼Œå°±æ˜¯æœ‰å¤šå°‘åˆ—      |   ğŸŒŸ   |
|    NR    | å·²ç»è¯»å‡ºçš„è®°å½•æ•°ï¼Œå°±æ˜¯è¡Œå·ï¼Œä»1å¼€å§‹     |   ğŸŒŸğŸŒŸ   |
|   FNR    | å½“å‰æ€»è®°å½•æ•°                        |   ğŸŒŸ   |
|    FS    | è¾“å…¥å­—æ®µåˆ†éš”ç¬¦ é»˜è®¤æ˜¯ç©ºæ ¼             |   ğŸŒŸ    |
|   OFS    | è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ é»˜è®¤ä¹Ÿæ˜¯ç©ºæ ¼           |      |
|    RS    | è¾“å…¥çš„è®°å½•ä»–éš”ç¬¦é»˜ è®¤ä¸ºæ¢è¡Œç¬¦         |      |
|   ORS    | è¾“å‡ºçš„è®°å½•åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºæ¢è¡Œç¬¦         |      |
| FILENAME | å½“å‰è¾“å…¥æ–‡ä»¶çš„åå­—                   |   ğŸŒŸ   |

> ç›¸å…³å‘½ä»¤

é€šç”¨æ–¹å¼ï¼š***'BEGIN {print "name, count"}  {print $1","$7;print $0;} END {print "end------"}'***
- printï¼šæ‰“å°è¾“å‡º
- printfï¼šæ ¼å¼åŒ–æ‰“å°è¾“å‡º(print format)
- beginï¼šç¬¬ä¸€è¡Œï¼Œä¸»è¦ç”¨æ¥æ‰“å°å¤´éƒ¨
- endï¼šæœ«å°¾ä¸€è¡Œï¼Œä¸»è¦ç”¨æ¥æ‰“å°ç»“æŸæ ‡è¯†
- ä¸­é—´éƒ¨åˆ†ï¼šå¯æ‰§è¡Œå¤šè¡Œè¯­å¥ï¼Œæ¯ä¸ªè¯­å¥ä»¥ï¼›ç»“æŸ
***å‘½ä»¤éœ€è¦åœ¨å•å¼•å·â€˜â€™å†…ï¼Œæœ‰beginã€endã€ä¸­é—´3éƒ¨é—¨ï¼Œbegin && endå¯çœç•¥***

### åŸºç¡€ä½¿ç”¨
    ç¯å¢ƒï¼šMacOs
    æ–‡ä»¶ï¼š/etc/passwd

> æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·å

å‘½ä»¤ï¼š***cat /etc/passwd |awk  -F ':'  '{print $1}'***
å°è§£ï¼š
- $1ï¼šåˆ†å‰²çš„åçš„ç¬¬1ä¸ªå˜é‡
![etc_1](etc_1.png)

> ç”¨æˆ·ä¸å¯¹åº”çš„shell

å‘½ä»¤ï¼š***cat /etc/passwd |awk  -F ':'  'BEGIN {print "start========="}  {print $1","$7} END {print "end------"}'***
å°è§£ï¼š
- $7ï¼šåˆ†å‰²çš„åçš„ç¬¬7ä¸ªå˜é‡
- beginï¼šè¾“å‡ºçš„ç¬¬ä¸€è¡Œæ ‡è¯†
- endï¼šè¾“å‡ºçš„ç»“æŸæ ‡è¯†(å›¾ç‰‡æœªæ˜¾ç¤ºå®Œå…¨)
![etc_2](etc_2.png)

> ç»Ÿè®¡/etc/passwd:æ–‡ä»¶åï¼Œè¡Œå·ï¼Œåˆ—æ•°

å‘½ä»¤ï¼š***cat /etc/passwd |awk  -F ':'  'BEGIN {print "start=========================="} {print "filename:" FILENAME ",linenumber:" NR ",columns:" NF ",linecontent:"$0}'***
å°è§£ï¼š
- $0ï¼šå½“å‰è¡Œçš„è®°å½•
- FILENAMEï¼šæ–‡ä»¶åç§°
- NRï¼šå½“å‰è®°å½•çš„è¡Œæ•°
- NFï¼šå½“å‰è®°å½•ä¸­çš„å­—æ®µä¸ªæ•°
![etc_3](etc_3.png)

> ç»Ÿè®¡ç”¨æˆ·æ•°é‡

å‘½ä»¤ï¼š***cat /etc/passwd |awk  -F ':'  'BEGIN {print "start=========================="} {print "filename:" FILENAME ",linenumber:" NR ",columns:" NF ",linecontent:"$0}'***
å°è§£ï¼š
- $0ï¼šå½“å‰è¡Œçš„è®°å½•
- FILENAMEï¼šæ–‡ä»¶åç§°
- NRï¼šå½“å‰è®°å½•çš„è¡Œæ•°
- NFï¼šå½“å‰è®°å½•ä¸­çš„å­—æ®µä¸ªæ•°
![etc_3](etc_3.png)

å‘½ä»¤ï¼š***cat /etc/passwd | awk '{count++;} END{print "user count is ", count}'***
![etc_4](etc_4.png)



### å®æˆ˜è§£ænginxçš„access.log
ç›´æ¥å¼•ç”¨æœ¬äººç°åœ¨è´Ÿè´£çš„é¡¹ç›®æ—¥å¿—è¿›è¡Œåˆ†æï¼Œ***reality && reliable ï¼ï¼ï¼***
> demo1

![isapi_dmeo](isapi_dmeo.png)

ç»Ÿè®¡ä¸åŒç±»å‹requireè¯·æ±‚çš„æ¬¡æ•°ï¼š
cat isapi-access.log | awk -F "require=|&" '{c[$2]+=1;} END{for (i in c) printf"%d\t%s\n",c[i], i;}' | sort -nr | head -n 20
ç»Ÿè®¡ipçš„è¯·æ±‚æ¬¡æ•°ï¼š
cat isapi-access.log | awk -F " " '{c[$1]+=1;} END{for (i in c) printf"%d\t%s\n",c[i], i;}' | sort -nr | head -n 20

> demo2

![papproval_dmeo](papproval_dmeo.png)

ç»Ÿè®¡ä¸åŒç±»å‹è¯·æ±‚æ¬¡æ•°
awk '{c[$7]+=1;} END{for (i in c) printf"%d\t%s\n",c[i], i;}' psapproval-access.log | sort -nr
ç»Ÿè®¡ipçš„è¯·æ±‚æ¬¡æ•°ï¼š
awk '{ips[$1]+=1;} END{for (ip in ips) printf("%d\t%s\n",ips[ip], ip);}' /home/q/var/log/psapproval-access.log | sort -nr

> å‘½ä»¤å°è§£

    catï¼šæŸ¥çœ‹æ–‡ä»¶
    awkï¼šåˆ†æå‘½ä»¤
    sortï¼šæ’åº
    headï¼šæŸ¥çœ‹æ–‡ä»¶ï¼Œä½†æ˜¯æ‰“å¼€çš„æ˜¯æ–‡ä»¶çš„å‰XXè¡Œ

### ç›¸å…³è¿æ¥
- ***isapi_access.logï¼š***https://github.com/GIS90/project_data_ref/blob/master/isapi_access.log
- ***psapproval_access.logï¼š***https://github.com/GIS90/project_data_ref/blob/master/psapproval_access.log

### è¿½åŠ è¯´æ˜
    æœ¬äººå¯¹awkä¹Ÿæ˜¯åˆæ­¥äº†è§£ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€ï¼Œä¸€èµ·shareã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å¾…ç»­
